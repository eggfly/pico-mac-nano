# 屏幕旋转功能说明

## 概述

这个项目为RP2040给ST7701S刷屏的代码添加了软件屏幕旋转功能。由于ST7701S硬件不支持旋转，我们通过软件方式实现了90度、180度和270度的屏幕旋转。

## 功能特性

- **90度顺时针旋转**: 将512×342的Macintosh画面旋转90度
- **270度顺时针旋转**: 将512×342的Macintosh画面旋转270度（等同于90度逆时针）
- **180度旋转**: 将512×342的Macintosh画面旋转180度
- **实时更新**: 在每次vsync时自动更新旋转缓冲区

## 实现原理

### 坐标映射
- **90度旋转**: `(x, y) → (y, 511-x)`
- **180度旋转**: `(x, y) → (511-x, 341-y)`
- **270度旋转**: `(x, y) → (341-y, x)`

### 缓冲区管理
- 对于90度和270度旋转，使用额外的旋转缓冲区（342×512）
- 对于0度和180度旋转，直接使用原始缓冲区
- 在每次vsync时更新旋转缓冲区

## 使用方法

### 1. 启用旋转功能

在`src/main.c`的`core1_main()`函数中，取消注释相应的旋转设置：

```c
// 启用90度顺时针旋转
video_set_rotation(ROTATION_90);

// 启用270度顺时针旋转（90度逆时针）
video_set_rotation(ROTATION_270);

// 启用180度旋转
video_set_rotation(ROTATION_180);

// 禁用旋转（正常显示）
video_set_rotation(ROTATION_0);
```

### 2. 编译和烧录

```bash
mkdir build
cd build
cmake ..
make
```

将生成的`firmware.uf2`文件烧录到RP2040设备。

## 性能考虑

### 内存使用
- 90/270度旋转需要额外的旋转缓冲区：342×512÷8 = 21,888字节
- 180度旋转不需要额外缓冲区

### CPU开销
- 90/270度旋转：每次vsync需要重新计算整个帧缓冲区
- 180度旋转：相对较低的开销
- 0度旋转：无额外开销

### 建议
- 如果内存紧张，建议使用180度旋转
- 如果需要90/270度旋转，确保有足够的RAM

## 技术细节

### 位操作优化
旋转算法针对1BPP（每像素1位）格式进行了优化：
- 使用位操作而不是字节操作
- 支持MSB优先的位序
- 高效的坐标映射

### DMA配置
- 自动调整DMA传输大小以适应旋转后的分辨率
- 保持与PIO视频输出的兼容性

## 故障排除

### 常见问题

1. **内存不足**
   - 错误信息：`Failed to allocate rotated framebuffer`
   - 解决方案：减少其他内存使用或使用180度旋转

2. **显示异常**
   - 检查旋转模式设置是否正确
   - 确认vsync更新是否正常工作

3. **性能问题**
   - 考虑降低系统时钟频率
   - 优化其他后台任务

## 扩展功能

### 动态旋转切换
可以通过按键或其他输入方式动态切换旋转模式：

```c
// 示例：按键切换旋转模式
if (key_pressed) {
    static rotation_mode_t current = ROTATION_0;
    current = (current + 1) % 4; // 循环切换
    video_set_rotation(current);
}
```

### 自定义旋转角度
当前实现支持90度的倍数旋转。如果需要其他角度，需要修改坐标映射函数。

## 许可证

本功能遵循与原项目相同的MIT许可证。



