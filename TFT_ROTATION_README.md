# ST7701S TFT屏幕软件旋转实现

## 概述

由于ST7701S TFT控制器不支持硬件旋转功能，我们实现了软件旋转来将竖屏显示（480x640）转换为横屏显示（640x480）。

## 实现原理

### 1. 显示系统架构

这个项目使用的是 **PIO + RGB并行接口** 的显示系统：

```
Mac帧缓冲区 → DMA → PIO程序 → RGB时序信号 → TFT屏幕
```

- **PIO程序** (`pio_video.pio`) 生成 HSync、VSync、Pixel Clock 时序
- **DMA** 从帧缓冲区读取像素数据
- **RGB并行接口** 直接输出到TFT屏幕

### 2. 软件旋转算法

在帧缓冲区层面实现90度顺时针旋转：

```c
// 原始坐标 (x, y) -> 旋转后坐标 (dst_x, dst_y)
dst_x = src_height - 1 - y;  // 旋转后的x坐标
dst_y = x;                   // 旋转后的y坐标
```

### 3. 显示参数调整

- **原始配置**：480x640（竖屏）
- **旋转后配置**：640x480（横屏）
- **帧缓冲区**：512x342（Mac原始分辨率）

### 4. 关键修改

#### 视频处理 (`src/video.c`)
- 添加了软件旋转函数 `video_rotate_framebuffer()`
- 修改了 `video_line_addr()` 函数使用旋转后的缓冲区
- 在DMA中断中每帧重新计算旋转

#### 视频配置
- 保持原始分辨率：`VIDEO_HRES = 480`, `VIDEO_VRES = 640`
- 在数据层面进行旋转，而不是改变时序

## 使用方法

### 1. 启用软件旋转

在 `src/tft_2p.c` 中设置：
```c
#define TFT_ROTATION_ENABLED 1  // 启用软件旋转
```

### 2. 调用旋转显示函数

```c
// 显示旋转后的帧缓冲区
tft_display_rotated(framebuffer, width, height);
```

### 3. 测试程序

运行 `src/tft_test.c` 来测试软件旋转功能。

## 性能考虑

### 内存使用
- 需要额外的旋转缓冲区：`TFT_ROTATED_WIDTH * TFT_ROTATED_HEIGHT / 32`
- 旋转操作需要CPU时间进行像素重排

### 优化建议
1. **DMA传输**：可以考虑使用DMA来加速旋转后的数据传输
2. **缓存优化**：对于静态内容，可以预计算旋转结果
3. **部分更新**：只旋转需要更新的区域

## 兼容性

### 支持的旋转角度
- 目前支持90度顺时针旋转
- 可以扩展支持180度和270度旋转

### 分辨率支持
- 支持任意分辨率的旋转
- 当前配置：512x342 -> 342x512

## 注意事项

1. **内存限制**：旋转缓冲区需要额外的RAM空间
2. **性能影响**：软件旋转会增加CPU负载
3. **实时性**：对于高刷新率应用，需要考虑旋转计算时间

## 未来改进

1. **硬件加速**：如果可能，考虑使用PIO或DMA来加速旋转
2. **多角度支持**：添加180度和270度旋转支持
3. **动态切换**：运行时切换旋转角度
4. **性能优化**：使用查找表或SIMD指令优化旋转算法
